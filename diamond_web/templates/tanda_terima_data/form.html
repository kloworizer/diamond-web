<form method="post" action="{{ form_action }}">
    {% csrf_token %}
    <div class="modal-body">
        <div class="alert alert-info mb-3">
            <i class="ri-information-line me-2"></i>
            <strong>Informasi:</strong> Buat tanda terima untuk tiket ini.
        </div>
        
        {% if form.non_field_errors %}
            <div class="alert alert-danger mb-3">
                {% for error in form.non_field_errors %}
                    <p class="mb-0">{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}
        
        <div class="mb-3">
            {{ form.tanggal_tanda_terima.label_tag }}
            {{ form.tanggal_tanda_terima }}
            {% if form.tanggal_tanda_terima.errors %}
                <small class="text-danger d-block mt-1">
                    {% for error in form.tanggal_tanda_terima.errors %}
                        {{ error }}
                    {% endfor %}
                </small>
            {% endif %}
            {% if form.tanggal_tanda_terima.help_text %}
                <small class="text-muted d-block mt-1">{{ form.tanggal_tanda_terima.help_text|safe }}</small>
            {% endif %}
        </div>

        <div class="mb-3">
            {{ form.nomor_tanda_terima.label_tag }}
            {{ form.nomor_tanda_terima }}
            {% if form.nomor_tanda_terima.errors %}
                <small class="text-danger d-block mt-1">
                    {% for error in form.nomor_tanda_terima.errors %}
                        {{ error }}
                    {% endfor %}
                </small>
            {% endif %}
            {% if form.nomor_tanda_terima.help_text %}
                <small class="text-muted d-block mt-1">{{ form.nomor_tanda_terima.help_text|safe }}</small>
            {% endif %}
        </div>
        
        <div class="mb-3">
            {{ form.deskripsi.label_tag }}
            {{ form.deskripsi }}
            {% if form.deskripsi.errors %}
                <small class="text-danger d-block mt-1">
                    {% for error in form.deskripsi.errors %}
                        {{ error }}
                    {% endfor %}
                </small>
            {% endif %}
            {% if form.deskripsi.help_text %}
                <small class="text-muted d-block mt-1">{{ form.deskripsi.help_text|safe }}</small>
            {% endif %}
        </div>

        <div class="mb-3">
            {{ form.id_ilap.label_tag }}
            {{ form.id_ilap }}
            {% if form.id_ilap.errors %}
                <small class="text-danger d-block mt-1">
                    {% for error in form.id_ilap.errors %}
                        {{ error }}
                    {% endfor %}
                </small>
            {% endif %}
            {% if form.id_ilap.help_text %}
                <small class="text-muted d-block mt-1">{{ form.id_ilap.help_text|safe }}</small>
            {% endif %}
        </div>
        
        {% if form.tiket_ids %}
        <div class="mb-3">
            <label class="form-label">{{ form.tiket_ids.label }}</label>
            <div id="tiket-checkbox-container" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px;">
                {% for checkbox in form.tiket_ids %}
                    <div class="form-check">
                        {{ checkbox.tag }}
                        <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                            {{ checkbox.choice_label }}
                        </label>
                    </div>
                {% endfor %}
            </div>
            {% if form.tiket_ids.errors %}
                <small class="text-danger d-block mt-1">
                    {% for error in form.tiket_ids.errors %}
                        {{ error }}
                    {% endfor %}
                </small>
            {% endif %}
        </div>
        {% endif %}
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="submit" class="btn btn-info">
            <i class="ri-save-line me-1"></i>Simpan
        </button>
    </div>
</form>

<script>
    (function () {
        const tanggalInput = document.getElementById('id_tanggal_tanda_terima');
        const nomorInput = document.getElementById('id_nomor_tanda_terima');
        const ilapInput = document.getElementById('id_id_ilap');
        const tiketContainer = document.getElementById('tiket-checkbox-container');

        if (!tanggalInput || !nomorInput) {
            return;
        }

        const updateNomor = () => {
            const tanggalValue = tanggalInput.value;
            if (!tanggalValue) {
                return;
            }

            fetch(`{% url "tanda_terima_next_number" %}?tanggal=${encodeURIComponent(tanggalValue)}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.success && data.nomor_tanda_terima) {
                        nomorInput.value = data.nomor_tanda_terima;
                    }
                })
                .catch(() => {
                    // ignore
                });
        };

        tanggalInput.addEventListener('change', updateNomor);

        const renderTikets = (items) => {
            if (!tiketContainer) {
                return;
            }
            if (!items || items.length === 0) {
                tiketContainer.innerHTML = '<div class="text-muted">Tidak ada tiket tersedia.</div>';
                return;
            }
            tiketContainer.innerHTML = items.map((item) => {
                return `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="tiket_ids" value="${item.id}" id="tiket-${item.id}">
                        <label class="form-check-label" for="tiket-${item.id}">${item.label}</label>
                    </div>
                `;
            }).join('');
        };

        const loadTiketsByIlap = () => {
            if (!ilapInput || !tiketContainer) {
                return;
            }
            const ilapId = ilapInput.value;
            if (!ilapId) {
                tiketContainer.innerHTML = '<div class="text-muted">Pilih ILAP terlebih dahulu.</div>';
                return;
            }
            fetch(`{% url "tanda_terima_tikets_by_ilap" %}?ilap_id=${encodeURIComponent(ilapId)}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.success) {
                        renderTikets(data.data || []);
                    }
                })
                .catch(() => {
                    // ignore
                });
        };

        if (ilapInput && !ilapInput.disabled) {
            ilapInput.addEventListener('change', loadTiketsByIlap);
        }
    })();
</script>
