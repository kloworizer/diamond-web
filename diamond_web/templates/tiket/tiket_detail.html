{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="ri-file-list-3-line me-2"></i>{{ page_title }}
                    </h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'tiket_list' %}">Tiket</a></li>
                            <li class="breadcrumb-item active">{{ tiket.nomor_tiket }}</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <span class="badge {{ status_badge_class }} fs-6 px-3 py-2">
                        <i class="ri-checkbox-circle-line me-1"></i>{{ status_label }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Tiket Information Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="ri-ticket-2-line me-2"></i>Informasi Tiket</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Nomor Tiket</label>
                                <p class="fw-bold mb-0 fs-5 text-primary">{{ tiket.nomor_tiket }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Periode</label>
                                <p class="fw-semibold mb-0">
                                    <span class="badge bg-dark">{{ periode_formatted }}</span>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Tanggal Terima Vertikal</label>
                                <p class="fw-semibold mb-0">
                                    {% if tiket.tgl_terima_vertikal %}
                                        <i class="ri-calendar-line me-1"></i>{{ tiket.tgl_terima_vertikal|date:"d/m/Y H:i" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Tanggal Terima DIP</label>
                                <p class="fw-semibold mb-0">
                                    {% if tiket.tgl_terima_dip %}
                                        <i class="ri-calendar-line me-1"></i>{{ tiket.tgl_terima_dip|date:"d/m/Y H:i" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% if tiket.id_jenis_prioritas_data %}
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Jenis Prioritas Data</label>
                                <p class="fw-semibold mb-0">
                                    <span class="badge bg-warning text-dark">{{ tiket.id_jenis_prioritas_data }}</span>
                                </p>
                            </div>
                        </div>
                        {% endif %}
                        {% if tiket.nomor_nd_nadine %}
                        <div class="col-md-4">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Nomor ND Nadine</label>
                                <p class="fw-semibold mb-0">{{ tiket.nomor_nd_nadine }}</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Tanggal Nadine</label>
                                <p class="fw-semibold mb-0">
                                    {% if tiket.tgl_nadine %}
                                        <i class="ri-calendar-line me-1"></i>{{ tiket.tgl_nadine|date:"d/m/Y H:i" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Tanggal Kirim PIDE</label>
                                <p class="fw-semibold mb-0">
                                    {% if tiket.tgl_kirim_pide %}
                                        <i class="ri-calendar-line me-1"></i>{{ tiket.tgl_kirim_pide|date:"d/m/Y H:i" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ILAP Information Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="ri-database-2-line me-2"></i>Informasi ILAP</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Nama ILAP</label>
                                <p class="fw-semibold mb-0">{{ ilap_info.nama_ilap }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Kategori ILAP</label>
                                <p class="fw-semibold mb-0">{{ ilap_info.kategori_ilap }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Kategori Wilayah</label>
                                <p class="fw-semibold mb-0">{{ ilap_info.kategori_wilayah }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Jenis Tabel</label>
                                <p class="fw-semibold mb-0">{{ ilap_info.jenis_tabel }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="text-muted small mb-1">ID Sub Jenis Data</label>
                                <p class="fw-semibold mb-0">
                                    <span class="badge bg-secondary">{{ ilap_info.id_sub_jenis_data }}</span>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Nama Sub Jenis Data</label>
                                <p class="fw-semibold mb-0">{{ ilap_info.nama_sub_jenis_data }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Deskripsi Periode</label>
                                <p class="fw-semibold mb-0">{{ ilap_info.deskripsi_periode }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Jenis Prioritas</label>
                                <p class="fw-semibold mb-0">
                                    {% if ilap_info.jenis_prioritas == 'Ya' %}
                                    <span class="badge bg-success">Ya</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Tidak</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% if ilap_info.klasifikasi %}
                        <div class="col-12">
                            <div class="info-group">
                                <label class="text-muted small mb-1">Klasifikasi</label>
                                <div class="d-flex flex-wrap gap-2">
                                    {% for klas in ilap_info.klasifikasi %}
                                    <span class="badge bg-info">{{ klas }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Tiket Actions History -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="ri-history-line me-2"></i>Riwayat Aksi</h5>
                </div>
                <div class="card-body">
                    {% if tiket_actions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="ri-time-line me-1"></i>Tanggal/Waktu</th>
                                    <th><i class="ri-user-line me-1"></i>User</th>
                                    <th><i class="ri-edit-line me-1"></i>Aksi</th>
                                    <th><i class="ri-file-text-line me-1"></i>Catatan</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for action in tiket_actions %}
                                <tr>
                                    <td class="text-nowrap">{{ action.timestamp|date:"d/m/Y H:i:s" }}</td>
                                    <td>{{ action.user_display }}</td>
                                    <td>
                                        <span class="badge {{ action.badge_class }}">{{ action.badge_label }}</span>
                                    </td>
                                    <td>{{ action.catatan|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        <i class="ri-information-line fs-1"></i>
                        <p class="mb-0">Tidak ada riwayat aksi.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Backup Data Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="ri-save-2-line me-2"></i>Backup Data</h5>
                </div>
                <div class="card-body">
                    {% if backup_list %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th><i class="ri-folder-2-line me-1"></i>Lokasi Backup</th>
                                        <th><i class="ri-user-line me-1"></i>User</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for backup in backup_list %}
                                        <tr>
                                            <td>{{ backup.lokasi_backup }}</td>
                                            <td>
                                                {% if backup.id_user %}
                                                    {{ backup.id_user.get_full_name|default:backup.id_user.username }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-3 text-muted">
                            <i class="ri-information-line fs-4"></i>
                            <p class="mb-0">Belum ada data backup.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tanda Terima Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="ri-file-list-2-line me-2"></i>Tanda Terima</h5>
                </div>
                <div class="card-body">
                    {% if tanda_terima_items %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th><i class="ri-hashtag me-1"></i>Nomor</th>
                                        <th><i class="ri-calendar-line me-1"></i>Tanggal</th>
                                        <th><i class="ri-file-text-line me-1"></i>Deskripsi</th>
                                        <th><i class="ri-user-line me-1"></i>Perekam</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in tanda_terima_items %}
                                        <tr>
                                            <td>{{ item.id_tanda_terima.nomor_tanda_terima }}</td>
                                            <td>{{ item.id_tanda_terima.tanggal_tanda_terima|date:"d/m/Y H:i" }}</td>
                                            <td>{{ item.id_tanda_terima.deskripsi }}</td>
                                            <td>{{ item.id_tanda_terima.id_perekam.get_full_name|default:item.id_tanda_terima.id_perekam.username }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-3 text-muted">
                            <i class="ri-information-line fs-4"></i>
                            <p class="mb-0">Belum ada tanda terima.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- PIC Assignment Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="ri-team-line me-2"></i>PIC (Penanggung Jawab)</h5>
                </div>
                <div class="card-body">
                    {% if tiket_pics %}
                    <div class="list-group list-group-flush">
                        {% for pic in tiket_pics %}
                        <div class="list-group-item px-0 py-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="fw-semibold mb-1">
                                        <i class="ri-user-3-line me-1"></i>{{ pic.user_display }}
                                    </div>
                                </div>
                                <span class="badge {{ pic.badge_class }} ms-2">{{ pic.badge_label }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        <i class="ri-user-unfollow-line fs-1"></i>
                        <p class="mb-0 small">Tidak ada PIC yang ditugaskan.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="ri-settings-3-line me-2"></i>Aksi</h5>
                </div>
                <div class="card-body">
                        {% if tiket.status < 6 %}
                        {% if not backup_list and not tanda_terima_items %}
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#rekamBackupDataModal">
                                    <i class="ri-save-line me-1"></i>Rekam Backup Data
                                </button>
                                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#createTandaTerimaModal">
                                    <i class="ri-file-list-2-line me-1"></i>Buat Tanda Terima
                                </button>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#batalkanTiketModal">
                                    <i class="ri-close-circle-line me-1"></i>Batalkan Tiket
                                </button>
                            </div>
                        {% elif not backup_list %}
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#rekamBackupDataModal">
                                    <i class="ri-save-line me-1"></i>Rekam Backup Data
                                </button>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#batalkanTiketModal">
                                    <i class="ri-close-circle-line me-1"></i>Batalkan Tiket
                                </button>
                            </div>
                        {% elif not tanda_terima_items %}
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#createTandaTerimaModal">
                                    <i class="ri-file-list-2-line me-1"></i>Buat Tanda Terima
                                </button>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#batalkanTiketModal">
                                    <i class="ri-close-circle-line me-1"></i>Batalkan Tiket
                                </button>
                            </div>
                            {% elif backup_list and tanda_terima_items %}
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#rekamHasilPenelitianModal" data-action="edit">
                                    <i class="ri-file-edit-line me-1"></i>{% if tiket.tgl_teliti %}Ubah Hasil Penelitian{% else %}Rekam Hasil Penelitian{% endif %}
                                </button>
                                {% if tiket.status == 4 %}
                                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#kirimTiketModal">
                                        <i class="ri-send-plane-line me-1"></i>Kirim Tiket ke PIDE
                                    </button>
                                {% endif %}
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#batalkanTiketModal">
                                    <i class="ri-close-circle-line me-1"></i>Batalkan Tiket
                                </button>
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-2">
                                <i class="ri-information-line me-1"></i>Tidak ada aksi yang tersedia untuk tiket ini.
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-2">
                            <i class="ri-information-line me-1"></i>Tidak ada aksi yang tersedia untuk tiket ini.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rekam Backup Data Modal -->
<div class="modal fade" id="rekamBackupDataModal" tabindex="-1" aria-labelledby="rekamBackupDataModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="rekamBackupDataModalLabel">Rekam Backup Data untuk Tiket {{ tiket.nomor_tiket }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="backup-data-form-container">
                <!-- Form will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Tanda Terima Modal -->
<div class="modal fade" id="createTandaTerimaModal" tabindex="-1" aria-labelledby="createTandaTerimaModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTandaTerimaModalLabel">Buat Tanda Terima untuk Tiket {{ tiket.nomor_tiket }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="tanda-terima-form-container">
                <!-- Form will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Batalkan Tiket Modal -->
<div class="modal fade" id="batalkanTiketModal" tabindex="-1" aria-labelledby="batalkanTiketModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="batalkanTiketModalLabel">Batalkan Tiket {{ tiket.nomor_tiket }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div id="batalkan-tiket-form-container">
                <!-- Form will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Rekam Hasil Penelitian Modal -->
<div class="modal fade" id="rekamHasilPenelitianModal" tabindex="-1" aria-labelledby="rekamHasilPenelitianModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="rekamHasilPenelitianModalLabel">Rekam Hasil Penelitian untuk Tiket {{ tiket.nomor_tiket }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div id="rekam-hasil-penelitian-form-container">
                <!-- Form will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Kirim Tiket Modal -->
<div class="modal fade" id="kirimTiketModal" tabindex="-1" aria-labelledby="kirimTiketModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="kirimTiketModalLabel">Kirim Tiket ke PIDE {{ tiket.nomor_tiket }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="kirim-tiket-form-container">
                <!-- Form will be loaded here -->
            </div>
        </div>
    </div>
</div>

<style>
    .info-group {
        padding: 0.5rem;
        border-left: 3px solid #dee2e6;
        background-color: #f8f9fa;
        border-radius: 4px;
    }

    .info-group:hover {
        background-color: #e9ecef;
        border-left-color: #0d6efd;
        transition: all 0.2s ease;
    }

    .card {
        border: none;
        transition: transform 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
    }

    .card-header {
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    }

    .badge {
        font-weight: 500;
        padding: 0.35em 0.65em;
    }

    .list-group-item {
        border-left: 3px solid transparent;
        transition: all 0.2s ease;
    }

    .list-group-item:hover {
        border-left-color: #0d6efd;
        background-color: #f8f9fa;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }

    .shadow-sm {
        box-shadow: 0 .125rem .25rem rgba(0, 0, 0, .075) !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rekamBackupDataModal = document.getElementById('rekamBackupDataModal');
        if (rekamBackupDataModal) {
            rekamBackupDataModal.addEventListener('show.bs.modal', function () {
                const formContainer = document.getElementById('backup-data-form-container');
                formContainer.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-warning" role="status"><span class="visually-hidden">Loading...</span></div></div>';

                fetch('{% url "backup_data_from_tiket_create" tiket.pk %}')
                    .then(response => response.text())
                    .then(html => {
                        formContainer.innerHTML = html;

                        // Handle form submission
                        const form = formContainer.querySelector('form');
                        if (form) {
                            form.addEventListener('submit', function (e) {
                                e.preventDefault();
                                const formData = new FormData(form);

                                fetch(form.action, {
                                    method: 'POST',
                                    body: formData,
                                    headers: {
                                        'X-Requested-With': 'XMLHttpRequest'
                                    }
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            bootstrap.Modal.getInstance(rekamBackupDataModal).hide();
                                            showToast('Success', data.message || 'Backup data berhasil disimpan.', 'success');
                                            setTimeout(() => location.reload(), 800);
                                        } else {
                                            formContainer.innerHTML = data.html || data.form_html || '<div class="alert alert-danger">Terjadi kesalahan</div>';
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error:', error);
                                        alert('Terjadi kesalahan saat menyimpan data.');
                                    });
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error loading form:', error);
                        formContainer.innerHTML = '<div class="alert alert-danger">Gagal memuat form</div>';
                    });
            });
        }

        const tandaTerimaModal = document.getElementById('createTandaTerimaModal');
        if (tandaTerimaModal) {
            tandaTerimaModal.addEventListener('show.bs.modal', function () {
                const formContainer = document.getElementById('tanda-terima-form-container');
                formContainer.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

                fetch('{% url "tanda_terima_data_from_tiket_create" tiket.pk %}')
                    .then(response => response.text())
                    .then(html => {
                        formContainer.innerHTML = html;
                        attachNomorTandaTerimaHandler(formContainer);

                        // Handle form submission
                        const form = formContainer.querySelector('form');
                        if (form) {
                            form.addEventListener('submit', function (e) {
                                e.preventDefault();
                                const formData = new FormData(form);

                                fetch(form.action, {
                                    method: 'POST',
                                    body: formData,
                                    headers: {
                                        'X-Requested-With': 'XMLHttpRequest'
                                    }
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            bootstrap.Modal.getInstance(tandaTerimaModal).hide();
                                            showToast('Success', data.message || 'Tanda terima berhasil dibuat.', 'success');
                                            setTimeout(() => location.reload(), 800);
                                        } else {
                                            // Handle form errors - the mixin returns 'html' not 'form_html'
                                            formContainer.innerHTML = data.html || data.form_html || '<div class="alert alert-danger">Terjadi kesalahan</div>';
                                            attachNomorTandaTerimaHandler(formContainer);
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error:', error);
                                        alert('Terjadi kesalahan saat menyimpan data.');
                                    });
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error loading form:', error);
                        formContainer.innerHTML = '<div class="alert alert-danger">Gagal memuat form</div>';
                    });
            });
        }

        const batalkanTiketModal = document.getElementById('batalkanTiketModal');
        if (batalkanTiketModal) {
            batalkanTiketModal.addEventListener('show.bs.modal', function () {
                const formContainer = document.getElementById('batalkan-tiket-form-container');
                formContainer.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-danger" role="status"><span class="visually-hidden">Loading...</span></div></div>';

                fetch('{% url "batalkan_tiket" tiket.pk %}', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.text())
                    .then(html => {
                        formContainer.innerHTML = html;

                        // Handle form submission
                        const form = formContainer.querySelector('form');
                        if (form) {
                            form.addEventListener('submit', function (e) {
                                e.preventDefault();
                                const formData = new FormData(form);

                                fetch(form.action, {
                                    method: 'POST',
                                    body: formData
                                })
                                    .then(response => {
                                        if (response.ok && response.redirected) {
                                            bootstrap.Modal.getInstance(batalkanTiketModal).hide();
                                            showToast('Success', 'Tiket berhasil dibatalkan.', 'success');
                                            setTimeout(() => location.reload(), 800);
                                        } else {
                                            return response.text();
                                        }
                                    })
                                    .then(html => {
                                        if (html) {
                                            formContainer.innerHTML = html;
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error:', error);
                                        alert('Terjadi kesalahan saat membatalkan tiket.');
                                    });
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error loading form:', error);
                        formContainer.innerHTML = '<div class="alert alert-danger m-3">Gagal memuat form</div>';
                    });
            });
        }

        const rekamHasilPenelitianModal = document.getElementById('rekamHasilPenelitianModal');
        if (rekamHasilPenelitianModal) {
            rekamHasilPenelitianModal.addEventListener('show.bs.modal', function () {
                const formContainer = document.getElementById('rekam-hasil-penelitian-form-container');
                formContainer.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

                fetch('{% url "rekam_hasil_penelitian" tiket.pk %}', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.text())
                    .then(html => {
                        formContainer.innerHTML = html;

                        // Handle form submission
                        const form = formContainer.querySelector('form');
                        if (form) {
                            form.addEventListener('submit', function (e) {
                                e.preventDefault();
                                const formData = new FormData(form);

                                fetch(form.action, {
                                    method: 'POST',
                                    body: formData,
                                    headers: {
                                        'X-Requested-With': 'XMLHttpRequest'
                                    }
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            bootstrap.Modal.getInstance(rekamHasilPenelitianModal).hide();
                                            showToast('Success', data.message || 'Hasil penelitian berhasil disimpan.', 'success');
                                            setTimeout(() => location.reload(), 800);
                                        } else {
                                            formContainer.innerHTML = data.html || data.form_html || '<div class="alert alert-danger">Terjadi kesalahan</div>';
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error:', error);
                                        alert('Terjadi kesalahan saat menyimpan data.');
                                    });
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error loading form:', error);
                        formContainer.innerHTML = '<div class="alert alert-danger">Gagal memuat form</div>';
                    });
            });
        }

            const kirimTiketModal = document.getElementById('kirimTiketModal');
            if (kirimTiketModal) {
                kirimTiketModal.addEventListener('show.bs.modal', function () {
                    const formContainer = document.getElementById('kirim-tiket-form-container');
                    formContainer.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div></div>';

                    fetch('{% url "kirim_tiket_from_tiket" tiket.pk %}', {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => response.text())
                        .then(html => {
                            formContainer.innerHTML = html;

                            const form = formContainer.querySelector('form');
                            if (form) {
                                form.addEventListener('submit', function (e) {
                                    e.preventDefault();
                                    const formData = new FormData(form);

                                    fetch(form.action, {
                                        method: 'POST',
                                        body: formData,
                                        headers: {
                                            'X-Requested-With': 'XMLHttpRequest'
                                        }
                                    })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.success) {
                                                bootstrap.Modal.getInstance(kirimTiketModal).hide();
                                                showToast('Success', data.message || 'Tiket berhasil dikirim.', 'success');
                                                setTimeout(() => location.reload(), 800);
                                            } else if (data.errors) {
                                                formContainer.innerHTML = data.html || data.form_html || '<div class="alert alert-danger">Terjadi kesalahan</div>';
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Error:', error);
                                            alert('Terjadi kesalahan saat mengirim tiket.');
                                        });
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error loading form:', error);
                            formContainer.innerHTML = '<div class="alert alert-danger">Gagal memuat form</div>';
                        });
                });
            }

        function attachNomorTandaTerimaHandler(container) {
            const tanggalInput = container.querySelector('#id_tanggal_tanda_terima');
            const nomorInput = container.querySelector('#id_nomor_tanda_terima');
            if (!tanggalInput || !nomorInput) {
                return;
            }

            const updateNomor = () => {
                const tanggalValue = tanggalInput.value;
                if (!tanggalValue) {
                    return;
                }

                fetch(`{% url "tanda_terima_next_number" %}?tanggal=${encodeURIComponent(tanggalValue)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.success && data.nomor_tanda_terima) {
                            nomorInput.value = data.nomor_tanda_terima;
                        }
                    })
                    .catch(() => {
                        // ignore
                    });
            };

            tanggalInput.addEventListener('change', updateNomor);
        }
    });
</script>
{% endblock %}